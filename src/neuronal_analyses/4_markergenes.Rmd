---
title: "240410_socop_markergenes"
output: html_document
date: "2024-12-10"
---
# Set up environment
```{r message=FALSE, warning=TRUE}
# Change this to your directory
.libPaths("/ref/jdlab/software/r-envs/simona/r-packages/4.2/")

library(Seurat)
library(patchwork)
library(corrplot)
library(tidyverse)
library(scCustomize)
library(monocle3)

set.seed(420)

source("../color_utils.R")
```

```{r load in data}
combined_neuronal <- readRDS("../../data/250228_combined.neuronal_1-5_5pct.rds")
combined_neuronal
```

# Monocle dimensional reduction
The UMAP generated by Seurat is ok, however I found that Monocle3 generated a much nicer one. This is purely for visualization purposes. The clustering information is the same across both UMAPs.

Convert Seurat object to Monocle3 CellDataSet (CDS):
Form CDS:
```{r create expression matrix}
expression_matrix <- combined_neuronal@assays$RNA@counts

# Get cell metadata
cell_metadata <- combined_neuronal@meta.data
if (all.equal(colnames(expression_matrix), rownames(cell_metadata))) {
  print(sprintf("Cell identifiers match"))
} else {
  print(sprintf(
    "Cell identifier mismatch - %i cells in expression matrix, %i cells in metadata",
    ncol(expression_matrix), nrow(cell_metadata)
  ))
  print("If the counts are equal, sort differences will throw this error")
}
```

```{r get gene annotations}
gene_annotation <- data.frame(gene_short_name = rownames(combined_neuronal@assays$RNA), row.names = rownames(combined_neuronal@assays$RNA))
rownames(expression_matrix) <- gene_annotation$gene_short_name

if (all.equal(rownames(expression_matrix), rownames(gene_annotation))) {
  print(sprintf("Gene identifiers all match"))
} else {
  print(sprintf(
    "Gene identifier mismatch - %i genes in expression matrix, %i gene in gene annotation",
    nrow(expression_matrix), nrow(gene_annotation)
  ))
  print("If the counts are equal, sort differences will throw this error")
}
```


```{r make cds}
cds <- new_cell_data_set(expression_matrix,
  cell_metadata = cell_metadata,
  gene_metadata = gene_annotation
)
```

Transfer Seurat embeddings and cluster info to get same UMAP. 
```{r transfer embeddings}
reducedDim(cds, type = "PCA") <- combined_neuronal@reductions$pca@cell.embeddings
cds@reduce_dim_aux$prop_var_expl <- combined_neuronal@reductions$pca@stdev

rowData(cds)$gene_name <- rownames(cds)
rowData(cds)$gene_short_name <- rowData(cds)$gene_name
cds@int_colData@listData$reducedDims$UMAP <- combined_neuronal@reductions$umap@cell.embeddings
```

```{r copy cluster info}
combined_neuronal@meta.data$cell_type <- factor(combined_neuronal@meta.data$cell_type, levels = unique(combined_neuronal@meta.data$cell_type))
cds@clusters$UMAP_so$clusters <- combined_neuronal@meta.data$cell_type
```

We will go through the general preprocessing of the cds object since some of that information does not carry over from the SeuratObject.
Note: The preprocessing function takes several minutes to run.

```{r general preprocessing}
cds <- preprocess_cds(cds, num_dim = 100)
plot_pc_variance_explained(cds)

plot_cells(cds)
```

We can use our previously computed cluster information to color the UMAP.
```{r umap plot}
cds$cell_type <- Idents(combined_neuronal)

plot_cells(cds,
  color_cells_by = "cell_type",
  label_groups_by_cluster = FALSE,
  label_leaves = FALSE,
  label_branch_points = FALSE,
  show_trajectory_graph = FALSE,
  label_roots = FALSE,
  label_cell_groups = FALSE,
  rasterize = FALSE,
  cell_size = 0.3,
  alpha = 0.3
) +
  scale_color_manual(values = palette_90) +
  theme(legend.position = "none")

ggsave("../../results/intermed-figs/250303_umap_1-5_5pct_res1.8_50dims_neuronal_monocle.png",
  device = png,
  dpi = 600,
  width = 6,
  height = 6
)
```

```{r umap by sample plot}
plot_cells(cds,
  color_cells_by = "sample",
  label_groups_by_cluster = FALSE,
  label_leaves = FALSE,
  label_branch_points = FALSE,
  show_trajectory_graph = FALSE,
  label_roots = FALSE,
  label_cell_groups = FALSE,
  rasterize = FALSE,
  cell_size = 0.3,
  alpha = 0.5
) +
  theme(legend.position = "right")

ggsave("../../results/intermed-figs/250303_umap_1-5_5pct_res1.8_50dims_neuronal_monocle_bysample.png",
  device = png,
  dpi = 600,
  width = 6,
  height = 6
)
```

```{r add cell embeddings}
rowData(cds)$gene_name <- rownames(cds)
rowData(cds)$gene_short_name <- rowData(cds)$gene_name
cds@int_colData@listData$reducedDims$UMAP <- combined_neuronal@reductions$umap@cell.embeddings
```

```{r save cds}
saveRDS(cds, "../../data/250303_cds_1-5_5pct_res1.8_50dims_neuronal.rds")
```


# Marker gene expression
Let's explore some marker gene expression to understand the nuclei in the UMAP. 
```{r function for GEX plots}
# Function to create gene expression plots
plot_gene_list <- function(combined_neuronal, cds, gene_list, output_dir, min_expr = 30, width = 6) {
  # Create output directory if it doesn't exist
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }

  # Convert the comma-separated string to a vector if needed
  if (is.character(gene_list) && length(gene_list) == 1) {
    gene_list <- unlist(strsplit(gene_list, ",\\s*"))
  }

  # Function to clean gene names for filenames
  clean_filename <- function(x) {
    gsub("[^[:alnum:]]", "", x)
  }

  # Loop through each gene
  for (gene in gene_list) {
    tryCatch(
      {
        # Get range of expression
        gene_range <- range(FetchData(object = combined_neuronal, vars = gene, layer = "counts"))
        print(paste(
          "Processing gene:", gene, "- Expression range:",
          paste(round(gene_range, 2), collapse = " to ")
        ))

        # Create the plot
        p <- plot_cells(cds,
          genes = gene,
          min_expr = min_expr,
          cell_size = 0.3,
          alpha = 1
        ) +
          theme(legend.position = "none")

        # Generate filename
        filename <- file.path(
          output_dir,
          paste0("250214-", clean_filename(gene), "-expression.png")
        )

        # Save the plot
        ggsave(filename,
          plot = p,
          device = png,
          dpi = 300,
          width = width
        )

        print(paste("Saved plot for", gene, "at", filename))
      },
      error = function(e) {
        warning(paste("Error processing gene:", gene, "-", e$message))
      }
    )
  }
}
```

```{r gene list}
genes <- c("Sim1", "Nr5a1", "Agrp", "Pomc", "Kiss1r", "Ghrh", "Npy", "Trh", "Nkx2-1", "Foxp2", "Lmo3", "Six3", "Nr2f2", "Rora", "Zic4", "Zic1", "Ebf1", "Peg10", "Meis2", "Bcl11a", "Prox1", "Slc17a7", "Slc2a2", "Moxd1", "Esr1", "Fos", "Jun", "Arc")
```

```{r plot!}
output_dir <- "../../results/markergenes/"
plot_gene_list(combined_neuronal, cds, genes, output_dir, min_expr = 1, width = 6)
```

# End
